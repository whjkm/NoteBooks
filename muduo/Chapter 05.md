- [Chapter 05](#chapter-05)
  - [Log Everything All The Time](#log-everything-all-the-time)
  - [日志库](#日志库)
    - [日志消息格式要点：](#日志消息格式要点)
    - [性能要求：](#性能要求)

# Chapter 05

## [Log Everything All The Time](http://highscalability.com/log-everything-all-time)

在prod环境中应该做到“Log Everything All The Time”。对于关键进程，通常需要记录：
- 收到的每条内部消息的id（还可以包括关键字段，长度，hash等）。
- 收到的每条外部消息的全文。
- 发出的每条消息的全文，每条消息的都有全局唯一的id。
- 关键内部状态的变更，etc.
- 每条日志都有时间戳，这样就能追踪分布式系统中一个事件的来龙去脉。

## 日志库

- 前端:供应用程序使用的接口（API），并生成日志消息（log message）。尽量做到低延迟，低CPU开销，无阻塞。
- 后端：把日志消息写到目的地。做到足够大的吞吐量，并占用较少资源。

### 日志消息格式要点：

- 尽量每条日志占一行。方便使用`awk`，`sed`，`grep`等命令行工具分析。
- 时间戳精确到微秒。每条消息都通过`gettimeofday(2)`获取当前时间。不会陷入内核。
- 始终使用GMT时区。
- 打印线程id。方便分析多线程程序的时序。
- 打印日志级别。
- 打印源文件名和行号。（错误定位）

### 性能要求：

- 每秒写成千上万条日志，没有明显的性能损失。
- 能应对一个进程产生大量日志数据的场景，例如 1GB/min。
- 不会阻塞正常的执行流程。
- 在多线程程序中，不会造成争用（contention）。
- 线程安全，多个线程可以并发写日志，两个线程的日志消息不会出现交织。
  


